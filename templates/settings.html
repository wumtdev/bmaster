<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Required meta tags-->
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="author" content="Pavel" />
		<meta name="keywords" content="Проект" />
		<title>Звонки в школе</title>
		<!-- shortcut icon-->
		<link
			rel="shortcut icon"
			href="static/img/logo_1.png"
			type="image/x-icon"
		/>
		<!-- Font awesome -->
		<link href="static/css/font-awesome.css" rel="stylesheet" />
		<!-- animat css-->
		<link href="static/css/animate.css" rel="stylesheet" />
		<!-- Bootstrap css-->
		<link href="static/css/bootstrap.css" rel="stylesheet" />
		<!-- Custom css-->
		<link href="static/css/style2.css" rel="stylesheet" />
	</head>
	<body>
		<!-- header start-->
		<header class="land-header fixed">
			<div class="container">
				<div class="row">
					<div class="col-12">
						<div class="header-contain position-relative">
							<div class="col-xxl-1 col-lg-1 col-2 wow fadeInUp">
								<div class="codex-brand logo-img">
									<a href="/"></a>
										<img class="img-fluid" src="static/img/logo_2.png" alt="" />
									</a>
									<br />
									<span class="logo-title">Звонок</span>
								</div>
							</div>

							<div class="col-xxl-1 col-lg-1 col-8 wow fadeInUp">
								<div class="bread-wrap"></div>
								<span class="liveTime"></span>

								<div class="bread-wrap"></div>
								<em><span class="getDate"></span></em>
							</div>

							<div class="col-xxl-8 col-lg-8 col-2 wow fadeInUp">
								<div class="d-flex align-items-center">
									<div class="menu-block">
										<ul class="menu-list">
											<li class="d-xl-none">
												<a class="close-menu" href="javascript:void(0);">
													<div class="menu-brand">
														<img
															class="img-fluid"
															src="static/img/logo_2.png"
															alt=""
														/>
														<i data-feather="x"></i>
													</div>
												</a>
											</li>
											<li class="menu-item">
												<a href="/">
													<i data-feather="file-text"></i>
													<b>Расписание звонков</b>
												</a>
											</li>
											<li class="menu-item">
												<a href="announcements">
													<i data-feather="mic"></i>
													<b>Объявления</b>
												</a>
											</li>
											<li class="menu-item">
												<a href="sounds">
													<i data-feather="book-open"></i>
													<b>Библиотека звуков</b>
												</a>
											</li>
											<li class="menu-item">
												<a href="#">
													<i data-feather="settings"></i>
													<b>Настройки</b>
												</a>
											</li>
											<li class="menu-item mob-menu">
												<a href="profile">
													<i data-feather="smile"></i>
													<b>Профиль</b>
												</a>
											</li>
										</ul>
										<a class="menu-action d-xl-none" href="javascript:void(0);">
											<i class="fa fa-bars"></i>
										</a>
									</div>
								</div>
							</div>

							<li class="nav-profile">
								<div class="media">
									<div class="user-icon"><i data-feather="user"></i></div>
									<div class="media-body">
										<h6>Романова</h6>
									</div>
								</div>
								<div class="menu-profile">
									<ul>
										<li><a href="profile">Профиль</a></li>
										<li>
											<a href="#">
												<i class="fa fa-sign-out"></i>
												Выйти
											</a>
										</li>
									</ul>
								</div>
							</li>
						</div>
					</div>
				</div>
			</div>
		</header>
		<!-- header end-->

		<!-- feathure start-->
		<section class="bg-white space-py-100" id="#">
			<div class="container">
				<div class="row">
					<div class=".col-xl-8 col-lg-6 col-12">
						<div class="land-title land-title2">
							<h3 class="wow fadeInUp" data-wow-duration="1s">Настройки</h3>
						</div>
					</div>
					<div class="row cdx-row justify-content-center">
						<div class=".col-xl-6 col-lg-6 col-12 wow fadeInUp">
							<div class="card user-card setting-bl">
								<div class="user-detailwrap">
									<div class="form-group off-ads">
										<div class="form-check custom-chek check-secondary">
											<label class="form-check-label" for="off-anouncements">
												Включить объявления
											</label>
											<input class="form-check-input" type="checkbox" value=""
											id="anouncements" {% if settings['enabled_anouncements']
											%} checked {% endif%}>
										</div>
										<p>
											Вкл/выкл возможность сделать объявление (использование
											микрофона).
										</p>
									</div>
									<hr />
									<div class="form-group on-break">
										<div class="form-check custom-chek check-danger">
											<label class="form-check-label" for="on-break">
												Включить каникулы
											</label>
											<input class="form-check-input" type="checkbox" value=""
											id="holiday_mode" {% if settings['enabled_holidayMode'] %}
											checked {% endif%}>
										</div>
										<p>Вкл/выкл школьные звонки на время каникул.</p>
									</div>

									<hr />
									<div class="form-group off-sounds">
										<div class="form-check custom-chek check-danger">
											<label class="form-check-label" for="off-sounds">
												Автоматическое выключение звуков
												<br />
												во время объявления
											</label>
											<input class="form-check-input" type="checkbox" value=""
											id="disabling_bells" {% if
											settings["disable_bells_when_anounce"] %} checked {%
											endif%}>
										</div>
									</div>

									<hr />
									<div class="form-group change-volume">
										<div class="range-wrap no-js">
											<label for="range" class="change-volume-label">
												Громкость звонков:
											</label>
											<input type="range" id="volume" class="range"
											value={{settings["bells_volume"]}} min="0" max="100">
											<output name="value" class="output" for="range"></output>
											<span>%</span>
										</div>
										<p>Регулирование громкости школьного звонка</p>
									</div>
									<hr />

									<div class="form-group change-duration">
										<div>
											<label for="tentacles" class="change-duration-label">
												Длительность школьного звонка:
											</label>
											<input type="number"
											value={{settings["default_bell_duration"]}}
											id="bell_duration" name="tentacles" min="5" max="30" />
											<span>сек</span>
											<p>
												Максимальная продолжительность звука: если звук длиннее,
												он не будет воспроизведен полностью.
											</p>
										</div>
									</div>

									<div class="land-title-save">
										<button class="btn btn-info" id="save-button" disabled>
											<i data-feather="save"></i>
											Сохранить
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- feathure end-->

		<!-- Toast сообщение -->
		<div class="toast-container position-fixed bottom-0 end-0 p-3">
			<div id="saveToast" class="toast" role="alert" aria-live="assertive" data-bs-delay="2500" aria-atomic="true">
				<div class="toast-header">
					<strong class="me-auto">Уведомление</strong>
					<small>Только что</small>
					<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
				</div>
				<div class="toast-body">
					Настройки успешно сохранены!
				</div>
			</div>
		</div>

		<!-- footer start-->
		<footer class="lan-footer space-py-100">
			<div class="container">
				<div class="row">
					<div class="col-lg-8 offset-lg-2">
						<div class="support-contain">
							<div class="codex-brand">
								<a href="#">
									<img
										class="img-fluid wow fadeInUp"
										src="static/img/logo_2.png"
										alt="theeme-logo"
									/>
								</a>
							</div>
							<h3 class="wow fadeInLeft">BellMaster</h3>
						</div>
					</div>
				</div>
			</div>
		</footer>
		<!-- footer end-->

		<!-- Feather iocns js-->
		<script src="static/js/feather.js"></script>

		<!-- Wow js-->
		<script src="static/js/wow.min.js"></script>

		<!-- Bootstrap js-->
		<script src="static/js/bootstrap.bundle.min.js"></script>

		<!-- main jquery-->
		<script src="static/js/jquery-3.6.0.js"></script>

		<script>
			//*** Header Js ***//
			$(window).scroll(function () {
				if ($(window).scrollTop() > 100) {
					$('header').addClass('sticky');
				} else {
					$('header').removeClass('sticky');
				}
			});

			//*** Menu Js ***//
			$(document).on('click', '.menu-action', function () {
				$('.menu-list').toggleClass('open');
			});
			$(document).on('click', '.close-menu', function () {
				$('.menu-list').removeClass('open');
			});

			document.addEventListener('mouseup', function (event) {
				var container = document.querySelector('.menu-list');

				if (!container.contains(event.target)) {
					$('.menu-list').removeClass('open');
				}
			});

			//*** BACK TO TOP START ***//
			$(window).scroll(function () {
				if ($(window).scrollTop() > 450) {
					$('.scroll-top').addClass('show');
				} else {
					$('.scroll-top').removeClass('show');
				}
			});
			$(document).ready(function () {
				$(document).on('click', '.scroll-top', function () {
					$('html, body').animate({ scrollTop: 0 }, '450');
				});
			});

			function getLiveTime(date) {
				const timeFormat = (v) => String(v).padStart(2, '0');

				const hours = timeFormat(date.getHours());
				const minutes = timeFormat(date.getMinutes());
				const seconds = timeFormat(date.getSeconds());
				return [hours, minutes, seconds].join(':');
			}
			$('.liveTime').text(getLiveTime(new Date()));
			function addTime() {
				$('.liveTime').text(getLiveTime(new Date()));
			}
			setInterval(function () {
				addTime();
			}, 1000);

			//*** LIVE DATE ***//
			function getDate(date) {
				var d = new Date(date),
					month = '' + (d.getMonth() + 1),
					day = '' + d.getDate(),
					year = d.getFullYear();

				if (month.length < 2) month = '0' + month;
				if (day.length < 2) day = '0' + day;
				return [day, month, year].join('/');
			}
			$('.getDate').text(getDate(new Date()));

			//*** DROPDOWN ACTION START ***//
			$('.action-menu .action-toggle').click(function () {
				$(this).next('.action-dropdown').toggleClass('active');
			});

			//*** WOW Js ***//
			new WOW().init();

			const range = document.querySelector('.range');
			const output = document.querySelector('.output');
			const onRangeInput = () => {
				const value = range.value;
				output.value = value;
			};
			onRangeInput();
			range.addEventListener('input', onRangeInput);
			const saveButton = document.getElementById('save-button');

			const formElements = document.querySelectorAll('input, select, textarea');

			// Функция для проверки изменений
			function checkForChanges() {
				let hasChanged = false;
				formElements.forEach((element) => {
					if (element.type === 'checkbox') {
						if (element.checked !== element.defaultChecked) {
							hasChanged = true;
						}
					} else if (element.type === 'range' || element.type === 'number') {
						if (element.value != element.defaultValue) {
							hasChanged = true;
						}
					} else {
						if (element.value !== element.defaultValue) {
							hasChanged = true;
						}
					}
				});
				if (hasChanged) {
					saveButton.removeAttribute('disabled');
				} else {
					saveButton.setAttribute('disabled', 'disabled');
				}
			}
			// Добавляем обработчики событий
			formElements.forEach((element) => {
				element.addEventListener('change', checkForChanges);
				element.addEventListener('input', checkForChanges);
			});

			// Отправка данных на Flask
			saveButton.addEventListener('click', () => {
				const formData = new FormData();
				formElements.forEach((element) => {
					if (element.type === 'checkbox') {
						formData.append(element.id, element.checked);
					} else {
						formData.append(element.id, element.value);
					}
				});

				fetch('/api/settings', {
					method: 'POST',
					body: formData,
				})
				.then(async (response) => {
						switch (response.status) {
							case 200:
								 // Показать toast сообщение
								const toastElement = document.getElementById('saveToast');
								const toast = new bootstrap.Toast(toastElement);
								toast.show();

								console.log('Settings saved');
								break;
							default:
								console.error(`Failed to save settings (${response.status}): ${await response.text()}`);
								break;
						}
				});
			});
		</script>
	</body>
</html>
